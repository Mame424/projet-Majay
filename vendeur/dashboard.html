<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MAJAY</title>
    <link rel="stylesheet" href="../css/dashboard.css">
    <style>
        .dashboard-page { background: #f7fafc; }
        .dashboard-header {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        .dashboard-header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dashboard-logo { font-size: 1.5em; font-weight: 900; color: #667eea; }
        .dashboard-nav { display: flex; gap: 20px; }
        .nav-link {
            color: #718096;
            text-decoration: none;
            font-weight: 600;
            padding: 10px 15px;
            border-radius: 8px;
        }
        .nav-link.active { background: #edf2f7; color: #667eea; }
        .dashboard-container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .stat-icon { font-size: 2.5em; margin-bottom: 10px; }
        .stat-label { color: #718096; font-size: 0.9em; margin-bottom: 8px; }
        .stat-value { font-size: 2em; font-weight: 800; color: #2d3748; }
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .action-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .loader {
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="dashboard-page">
    <header class="dashboard-header">
        <div class="dashboard-header-content">
            <div class="dashboard-logo">üõçÔ∏è MAJAY</div>
            <nav class="dashboard-nav">
                <a href="dashboard.html" class="nav-link active">üìä Dashboard</a>
                <a href="produits.html" class="nav-link">üì¶ Produits</a>
                <a href="commandes.html" class="nav-link">üõí Commandes</a>
                <a href="profil.html" class="nav-link">‚öôÔ∏è Profil</a>
            </nav>
            <div style="display: flex; gap: 15px; align-items: center;">
                <span class="badge" id="userPlan">FREE</span>
                <button onclick="window.authMajay.deconnexion()" style="background: none; border: none; cursor: pointer; font-size: 1.2em;">üö™</button>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <div style="margin-bottom: 30px;">
            <h1 style="font-size: 2em; margin-bottom: 10px;">Bonjour, <span id="userName">Vendeur</span> üëã</h1>
            <p style="color: #718096;">Voici un aper√ßu de votre activit√©</p>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                <div class="loader"></div>
                <p style="margin-top: 15px; color: #718096;">Chargement...</p>
            </div>
        </div>

        <div class="actions-grid">
            <div class="action-card" onclick="window.location.href='produits.html'">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin-bottom: 10px;">G√©rer mes produits</h3>
                        <p style="color: #718096;">Ajouter, modifier ou supprimer</p>
                    </div>
                    <div style="font-size: 2.5em;">üì¶</div>
                </div>
            </div>

            <div class="action-card" onclick="copierLien()">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin-bottom: 10px;">Partager ma boutique</h3>
                        <p style="color: #718096;">Copier le lien</p>
                    </div>
                    <div style="font-size: 2.5em;">üîó</div>
                </div>
            </div>

            <div class="action-card" onclick="window.location.href='commandes.html'">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin-bottom: 10px;">Mes commandes</h3>
                        <p style="color: #718096;">Historique et suivi</p>
                    </div>
                    <div style="font-size: 2.5em;">üõí</div>
                </div>
            </div>
        </div>

        <div style="background: white; border-radius: 16px; padding: 30px;">
            <h2 style="margin-bottom: 20px;">üìà Commandes r√©centes</h2>
            <div id="commandesRecentes">
                <div style="text-align: center; padding: 40px; color: #718096;">
                    Chargement...
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase } from "../js/config.js";
        import { authMajay } from "../js/auth.js";

        const session = authMajay.getSession();
        if (!session) window.location.href = 'connexion.html';

        document.getElementById('userName').textContent = session.nom;
        document.getElementById('userPlan').textContent = session.plan.toUpperCase();
        document.getElementById('userPlan').className = `badge badge-${session.plan}`;

        async function chargerStats() {
            try {
                const { data: produits } = await supabase
                    .from('produits')
                    .select('id')
                    .eq('vendeur_id', session.id);

                const { data: commandes } = await supabase
                    .from('commandes')
                    .select('total')
                    .eq('vendeur_id', session.id);

                const { data: stats } = await supabase
                    .from('stats_vendeurs')
                    .select('vues_catalogue')
                    .eq('vendeur_id', session.id);

                const nbProduits = produits?.length || 0;
                const nbCommandes = commandes?.length || 0;
                const totalVentes = commandes?.reduce((sum, c) => sum + parseFloat(c.total), 0) || 0;
                const totalVues = stats?.reduce((sum, s) => sum + s.vues_catalogue, 0) || 0;

                document.getElementById('statsGrid').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-icon">üì¶</div>
                        <div class="stat-label">Produits</div>
                        <div class="stat-value">${nbProduits}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üõí</div>
                        <div class="stat-label">Commandes</div>
                        <div class="stat-value">${nbCommandes}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-label">Ventes totales</div>
                        <div class="stat-value">${totalVentes.toLocaleString()} FCFA</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üëÅÔ∏è</div>
                        <div class="stat-label">Vues catalogue</div>
                        <div class="stat-value">${totalVues}</div>
                    </div>
                `;
            } catch (error) {
                console.error(error);
            }
        }

        async function chargerCommandes() {
            const { data } = await supabase
                .from('commandes')
                .select('*')
                .eq('vendeur_id', session.id)
                .order('created_at', { ascending: false })
                .limit(5);

            if (!data || data.length === 0) {
                document.getElementById('commandesRecentes').innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #718096;">
                        <div style="font-size: 3em; margin-bottom: 15px;">üõí</div>
                        <p>Aucune commande pour le moment</p>
                    </div>
                `;
                return;
            }

            document.getElementById('commandesRecentes').innerHTML = `
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th style="padding: 15px; text-align: left; background: #f7fafc; font-weight: 700;">Date</th>
                            <th style="padding: 15px; text-align: left; background: #f7fafc; font-weight: 700;">Produits</th>
                            <th style="padding: 15px; text-align: left; background: #f7fafc; font-weight: 700;">Total</th>
                            <th style="padding: 15px; text-align: left; background: #f7fafc; font-weight: 700;">Statut</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(cmd => `
                            <tr style="border-top: 1px solid #e2e8f0;">
                                <td style="padding: 15px;">${new Date(cmd.created_at).toLocaleDateString('fr-FR')}</td>
                                <td style="padding: 15px;">${cmd.items.length} article(s)</td>
                                <td style="padding: 15px; font-weight: 700; color: #25D366;">${parseInt(cmd.total).toLocaleString()} FCFA</td>
                                <td style="padding: 15px;"><span class="badge badge-${cmd.statut === 'confirme' ? 'success' : 'warning'}">${cmd.statut}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        window.copierLien = function() {
    const lien = window.location.origin + '/catalogue.html?shop=' + session.slug;
    navigator.clipboard.writeText(lien).then(() => {
        alert('‚úÖ Lien copi√© ! Partagez-le avec vos clients');
    });
};

        chargerStats();
        chargerCommandes();
    </script>
</body>
</html>