<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - MAJAY</title>
    <link rel="stylesheet" href="../css/whatsapp-dashboard.css">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #075E54 0%, #128C7E 100%);
            color: white;
            padding: 20px;
        }
        .admin-header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .dashboard-logo {
            font-size: 1.5em;
            font-weight: bold;
        }
        .admin-nav {
            display: flex;
            gap: 15px;
        }
        .admin-nav a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .admin-nav a:hover {
            background: rgba(255,255,255,0.1);
        }
        .admin-nav a.active {
            background: rgba(255,255,255,0.2);
        }
        .loader {
            border: 4px solid rgba(37, 211, 102, 0.2);
            border-top: 4px solid #25D366;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .content-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .content-card h2 {
            margin-bottom: 20px;
            color: #075E54;
        }
        .demande-card {
            border: 2px solid #ffa502;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            background: #fff9f0;
        }
        .demande-card strong {
            color: #075E54;
            font-size: 1.1em;
        }
        .demande-card button {
            margin-top: 15px;
            margin-right: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        table tr:hover {
            background: #f7fafc;
        }
        .btn-logout {
            background: none;
            border: 2px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }
        .btn-logout:hover {
            background: rgba(255,255,255,0.1);
        }
    </style>
</head>

<body>

<header class="admin-header">
    <div class="admin-header-content">
        <div class="dashboard-logo">üõ°Ô∏è ADMIN MAJAY</div>
        <nav class="admin-nav">
            <a href="dashboard.html" class="active">üìä Dashboard</a>
            <a href="vendeur.html">üë• Vendeurs</a>
        </nav>
        <div style="display:flex;gap:15px;align-items:center;">
            <span id="adminName" style="font-weight: 600;"></span>
            <button id="logoutBtn" class="btn-logout">
                üö™ D√©connexion
            </button>
        </div>
    </div>
</header>

<div class="dashboard-container">
    <h1 style="font-size:2em;margin-bottom:30px;color:#075E54;">Tableau de bord SuperAdmin</h1>

    <div class="stats-grid" id="statsGrid">
        <div style="grid-column:1/-1;text-align:center;padding:40px;">
            <div class="loader"></div>
            <p style="margin-top:15px;color:#718096;">Chargement des statistiques‚Ä¶</p>
        </div>
    </div>

    <div class="content-card">
        <h2>üìã Comptes en attente d'approbation</h2>
        <div id="demandesListe">
            <p style="color:#718096;">Chargement‚Ä¶</p>
        </div>
    </div>

    <div class="content-card">
        <h2>üìà Derni√®res commandes</h2>
        <div id="commandesRecentes">
            <p style="color:#718096;">Chargement‚Ä¶</p>
        </div>
    </div>
</div>

<script type="module">
    import { supabase } from "../js/config.js";
    import { adminAuth } from "../js/admin-auth.js";

    /* ============================
       SECURITE ADMIN (OTP EMAIL)
    ============================ */
    const admin = await adminAuth.verifierAdmin();

    if (!admin) {
        window.location.href = "connexion.html";
        throw new Error("Acc√®s admin refus√©");
    }

    document.getElementById("adminName").textContent = admin.nom || admin.email;

    document.getElementById("logoutBtn").onclick = () => {
        if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
            adminAuth.deconnexionAdmin();
        }
    };

    /* ============================
       STATS (VERSION CORRIG√âE)
    ============================ */
    async function chargerStats() {
        try {
            // ‚úÖ CHANGEMENT ICI : utiliser RPC au lieu de FROM
            const { data, error } = await supabase.rpc('get_stats_admin');
            
            if (error) throw error;

            // La fonction retourne un array avec 1 √©l√©ment
            const stats = data[0];

            document.getElementById("statsGrid").innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.total_vendeurs || 0}</div>
                    <div class="stat-label">Total Vendeurs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.total_produits || 0}</div>
                    <div class="stat-label">Produits</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.total_commandes || 0}</div>
                    <div class="stat-label">Commandes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">
                        ${parseInt(stats.volume_ventes || 0).toLocaleString()} FCFA
                    </div>
                    <div class="stat-label">Volume des ventes</div>
                </div>
            `;
        } catch (err) {
            console.error('Erreur chargement stats:', err);
            document.getElementById("statsGrid").innerHTML = `
                <div style="grid-column:1/-1;text-align:center;padding:40px;">
                    <p style="color:#ff4757;">‚ùå Erreur chargement stats</p>
                    <p style="color:#718096;font-size:0.9em;margin-top:10px;">${err.message}</p>
                </div>
            `;
        }
    }

    /* ============================
       DEMANDES VENDEURS
    ============================ */
    async function chargerDemandes() {
        try {
            const { data, error } = await supabase
                .from("vendeurs")
                .select("*")
                .eq("actif", false)
                .order("created_at", { ascending: false });

            if (error) throw error;

            if (!data || data.length === 0) {
                document.getElementById("demandesListe").innerHTML =
                    "<p style='color:#25D366;'>‚úÖ Aucune demande en attente</p>";
                return;
            }

            document.getElementById("demandesListe").innerHTML = data.map(v => `
                <div class="demande-card">
                    <strong>${v.nom}</strong><br>
                    üìû ${v.telephone}<br>
                    üîó ${v.slug}<br>
                    üìÖ ${new Date(v.created_at).toLocaleDateString('fr-FR')}
                    <div>
                        <button class="btn-success" onclick="approuver('${v.id}')">‚úÖ Approuver</button>
                        <button class="btn-danger" onclick="rejeter('${v.id}')">‚ùå Rejeter</button>
                    </div>
                </div>
            `).join("");
        } catch (err) {
            console.error('Erreur demandes:', err);
            document.getElementById("demandesListe").innerHTML =
                `<p style='color:#ff4757;'>‚ùå Erreur : ${err.message}</p>`;
        }
    }

    window.approuver = async (id) => {
        if (!confirm('Approuver ce vendeur ?')) return;
        
        try {
            const { error } = await supabase.rpc("admin_toggle_vendeur", {
                p_vendeur_id: id,
                p_actif: true
            });
            
            if (error) throw error;
            
            alert('‚úÖ Vendeur approuv√© !');
            chargerDemandes();
            chargerStats();
        } catch (err) {
            alert('‚ùå Erreur : ' + err.message);
        }
    };

    window.rejeter = async (id) => {
        if (!confirm('‚ö†Ô∏è Rejeter et supprimer d√©finitivement ce vendeur ?')) return;
        
        try {
            const { error } = await supabase.rpc("admin_delete_vendeur", {
                p_vendeur_id: id
            });
            
            if (error) throw error;
            
            alert('‚úÖ Vendeur supprim√©');
            chargerDemandes();
            chargerStats();
        } catch (err) {
            alert('‚ùå Erreur : ' + err.message);
        }
    };

    /* ============================
       COMMANDES
    ============================ */
    async function chargerCommandes() {
        try {
            const { data, error } = await supabase
                .from("commandes")
                .select("*, vendeurs(nom)")
                .order("created_at", { ascending: false })
                .limit(10);

            if (error) throw error;

            if (!data || data.length === 0) {
                document.getElementById("commandesRecentes").innerHTML =
                    "<p style='color:#718096;'>Aucune commande pour le moment</p>";
                return;
            }

            document.getElementById("commandesRecentes").innerHTML = `
                <table>
                    <tbody>
                        ${data.map(c => `
                            <tr>
                                <td>
                                    <strong>${new Date(c.created_at).toLocaleDateString('fr-FR')}</strong><br>
                                    <small style="color:#718096;">${new Date(c.created_at).toLocaleTimeString('fr-FR')}</small>
                                </td>
                                <td>${c.vendeurs?.nom || "N/A"}</td>
                                <td style="text-align:right;">
                                    <strong style="color:#25D366;">${parseInt(c.total || 0).toLocaleString()} FCFA</strong>
                                </td>
                            </tr>
                        `).join("")}
                    </tbody>
                </table>
            `;
        } catch (err) {
            console.error('Erreur commandes:', err);
            document.getElementById("commandesRecentes").innerHTML =
                `<p style='color:#ff4757;'>‚ùå Erreur : ${err.message}</p>`;
        }
    }

    /* ============================
       CHARGEMENT INITIAL
    ============================ */
    chargerStats();
    chargerDemandes();
    chargerCommandes();

    // Auto-refresh toutes les 30 secondes
    setInterval(() => {
        chargerStats();
        chargerDemandes();
        chargerCommandes();
    }, 30000);
</script>

</body>
</html>