<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - MAJAY</title>
    <link rel="stylesheet" href="../css/dashboard.css">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 20px;
        }
        .admin-nav a {
            color: white;
        }
        .admin-nav a.active {
            background: rgba(255,255,255,0.2);
        }
        .loader {
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="dashboard-page">

<header class="dashboard-header admin-header">
    <div class="dashboard-header-content">
        <div class="dashboard-logo">ğŸ›¡ï¸ ADMIN MAJAY</div>
        <nav class="dashboard-nav admin-nav">
            <a href="dashboard.html" class="nav-link active">ğŸ“Š Dashboard</a>
            <a href="vendeurs.html" class="nav-link">ğŸ‘¥ Vendeurs</a>
        </nav>
        <div style="display:flex;gap:15px;align-items:center;">
            <span id="adminName"></span>
            <button id="logoutBtn"
                style="background:none;border:none;cursor:pointer;font-size:1.2em;color:white;">
                ğŸšª
            </button>
        </div>
    </div>
</header>

<div class="dashboard-container">
    <h1 style="font-size:2em;margin-bottom:30px;">Tableau de bord SuperAdmin</h1>

    <div class="stats-grid" id="statsGrid">
        <div style="grid-column:1/-1;text-align:center;padding:40px;">
            <div class="loader"></div>
            <p style="margin-top:15px;color:#718096;">Chargement des statistiquesâ€¦</p>
        </div>
    </div>

    <div style="background:white;border-radius:16px;padding:30px;margin-top:30px;">
        <h2>ğŸ“‹ Comptes en attente d'approbation</h2>
        <div id="demandesListe">Chargementâ€¦</div>
    </div>

    <div style="background:white;border-radius:16px;padding:30px;margin-top:30px;">
        <h2>ğŸ“ˆ DerniÃ¨res commandes</h2>
        <div id="commandesRecentes">Chargementâ€¦</div>
    </div>
</div>

<script type="module">
    import { supabase } from "../js/config.js";
    import { adminAuth } from "../js/admin-auth.js";

    /* ============================
       SECURITE ADMIN (OTP EMAIL)
    ============================ */
    const admin = await adminAuth.verifierAdmin();

    if (!admin) {
        window.location.href = "connexion.html";
        throw new Error("AccÃ¨s admin refusÃ©");
    }

    document.getElementById("adminName").textContent = admin.nom;

    document.getElementById("logoutBtn").onclick = () => {
        adminAuth.deconnexionAdmin();
    };

    /* ============================
       STATS
    ============================ */
    async function chargerStats() {
        try {
            const { data } = await supabase
                .from("vue_stats_admin")
                .select("*")
                .single();

            document.getElementById("statsGrid").innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">ğŸ‘¥</div>
                    <div class="stat-label">Total Vendeurs</div>
                    <div class="stat-value">${data.total_vendeurs}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“¦</div>
                    <div class="stat-label">Produits</div>
                    <div class="stat-value">${data.total_produits}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ›’</div>
                    <div class="stat-label">Commandes</div>
                    <div class="stat-value">${data.total_commandes}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ’°</div>
                    <div class="stat-label">Volume</div>
                    <div class="stat-value">
                        ${parseInt(data.volume_ventes).toLocaleString()} FCFA
                    </div>
                </div>
            `;
        } catch {
            document.getElementById("statsGrid").innerHTML =
                "<p>âŒ Erreur chargement stats</p>";
        }
    }

    /* ============================
       DEMANDES VENDEURS
    ============================ */
    async function chargerDemandes() {
        const { data } = await supabase
            .from("vendeurs")
            .select("*")
            .eq("actif", false)
            .order("created_at", { ascending: false });

        if (!data || data.length === 0) {
            document.getElementById("demandesListe").innerHTML =
                "<p>âœ… Aucune demande</p>";
            return;
        }

        document.getElementById("demandesListe").innerHTML = data.map(v => `
            <div style="border:2px solid #ffa502;padding:20px;border-radius:12px;margin-bottom:15px;">
                <strong>${v.nom}</strong><br>
                ğŸ“ ${v.telephone}<br>
                ğŸ”— ${v.slug}<br><br>
                <button onclick="approuver('${v.id}')">âœ… Approuver</button>
                <button onclick="rejeter('${v.id}')">âŒ Rejeter</button>
            </div>
        `).join("");
    }

    window.approuver = async (id) => {
        await supabase.rpc("admin_toggle_vendeur", {
            p_vendeur_id: id,
            p_actif: true
        });
        chargerDemandes();
        chargerStats();
    };

    window.rejeter = async (id) => {
        await supabase.rpc("admin_delete_vendeur", {
            p_vendeur_id: id
        });
        chargerDemandes();
        chargerStats();
    };

    /* ============================
       COMMANDES
    ============================ */
    async function chargerCommandes() {
        const { data } = await supabase
            .from("commandes")
            .select("*, vendeurs(nom)")
            .order("created_at", { ascending: false })
            .limit(10);

        if (!data || data.length === 0) {
            document.getElementById("commandesRecentes").innerHTML =
                "<p>Aucune commande</p>";
            return;
        }

        document.getElementById("commandesRecentes").innerHTML = `
            <table style="width:100%">
                ${data.map(c => `
                    <tr>
                        <td>${new Date(c.created_at).toLocaleDateString()}</td>
                        <td>${c.vendeurs?.nom || "N/A"}</td>
                        <td>${parseInt(c.total).toLocaleString()} FCFA</td>
                    </tr>
                `).join("")}
            </table>
        `;
    }

    chargerStats();
    chargerDemandes();
    chargerCommandes();
</script>

</body>
</html>
